# è¾¹å¢™é²œé€ç³»ç»Ÿç›‘æ§å‘Šè­¦é…ç½®
# ç‰ˆæœ¬: 1.0.0
# æè¿°: Prometheus AlertManagerå‘Šè­¦è§„åˆ™é…ç½®

# ===========================================
# å…¨å±€é…ç½®
# ===========================================
global:
  # å‘Šè­¦è§£å†³è¶…æ—¶æ—¶é—´
  resolve_timeout: 5m
  # SMTPé…ç½®
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@biangqiang.com'
  smtp_auth_username: 'alerts@biangqiang.com'
  smtp_auth_password: 'your-email-password'
  smtp_require_tls: true

# ===========================================
# å‘Šè­¦è·¯ç”±é…ç½®
# ===========================================
route:
  # é»˜è®¤åˆ†ç»„ç­‰å¾…æ—¶é—´
  group_wait: 10s
  # åˆ†ç»„é—´éš”æ—¶é—´
  group_interval: 10s
  # é‡å¤å‘Šè­¦é—´éš”æ—¶é—´
  repeat_interval: 1h
  # é»˜è®¤æ¥æ”¶è€…
  receiver: 'default'
  # åˆ†ç»„æ ‡ç­¾
  group_by: ['alertname', 'cluster', 'service']
  
  # å­è·¯ç”±é…ç½®
  routes:
    # ä¸¥é‡å‘Šè­¦è·¯ç”±
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 30m
    
    # è­¦å‘Šå‘Šè­¦è·¯ç”±
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      group_interval: 30s
      repeat_interval: 2h
    
    # æ•°æ®åº“å‘Šè­¦è·¯ç”±
    - match:
        service: mysql
      receiver: 'database-alerts'
      group_wait: 10s
      repeat_interval: 1h
    
    # Rediså‘Šè­¦è·¯ç”±
    - match:
        service: redis
      receiver: 'cache-alerts'
      group_wait: 10s
      repeat_interval: 1h
    
    # åº”ç”¨æœåŠ¡å‘Šè­¦è·¯ç”±
    - match:
        service: backend
      receiver: 'application-alerts'
      group_wait: 15s
      repeat_interval: 1h
    
    # åŸºç¡€è®¾æ–½å‘Šè­¦è·¯ç”±
    - match:
        category: infrastructure
      receiver: 'infrastructure-alerts'
      group_wait: 20s
      repeat_interval: 2h

# ===========================================
# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
# ===========================================
inhibit_rules:
  # å½“å®ä¾‹å®•æœºæ—¶ï¼ŒæŠ‘åˆ¶è¯¥å®ä¾‹çš„å…¶ä»–å‘Šè­¦
  - source_match:
      severity: 'critical'
      alertname: 'InstanceDown'
    target_match:
      severity: 'warning'
    equal: ['instance']
  
  # å½“æœåŠ¡ä¸å¯ç”¨æ—¶ï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„æ€§èƒ½å‘Šè­¦
  - source_match:
      severity: 'critical'
      category: 'availability'
    target_match:
      severity: 'warning'
      category: 'performance'
    equal: ['service']

# ===========================================
# æ¥æ”¶è€…é…ç½®
# ===========================================
receivers:
  # é»˜è®¤æ¥æ”¶è€…
  - name: 'default'
    email_configs:
      - to: 'admin@biangqiang.com'
        subject: '[è¾¹å¢™é²œé€] ç³»ç»Ÿå‘Šè­¦é€šçŸ¥'
        body: |
          å‘Šè­¦è¯¦æƒ…:
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          æœåŠ¡åç§°: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        headers:
          Subject: '[è¾¹å¢™é²œé€] {{ .GroupLabels.alertname }} å‘Šè­¦é€šçŸ¥'
    
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=your-dingtalk-token'
        send_resolved: true
        title: '[è¾¹å¢™é²œé€] ç³»ç»Ÿå‘Šè­¦é€šçŸ¥'
        text: |
          ## ç³»ç»Ÿå‘Šè­¦é€šçŸ¥
          
          **å‘Šè­¦æ—¶é—´:** {{ .CommonAnnotations.timestamp }}
          
          {{ range .Alerts }}
          **å‘Šè­¦åç§°:** {{ .Annotations.summary }}
          
          **å‘Šè­¦æè¿°:** {{ .Annotations.description }}
          
          **å‘Šè­¦çº§åˆ«:** {{ .Labels.severity }}
          
          **æœåŠ¡åç§°:** {{ .Labels.service }}
          
          **å®ä¾‹åœ°å€:** {{ .Labels.instance }}
          
          **å¼€å§‹æ—¶é—´:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          ---
          {{ end }}
  
  # ä¸¥é‡å‘Šè­¦æ¥æ”¶è€…
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@biangqiang.com,dev@biangqiang.com'
        subject: '[ç´§æ€¥] è¾¹å¢™é²œé€ç³»ç»Ÿä¸¥é‡å‘Šè­¦'
        body: |
          ğŸš¨ ä¸¥é‡å‘Šè­¦é€šçŸ¥ ğŸš¨
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          æœåŠ¡åç§°: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          è¯·ç«‹å³å¤„ç†æ­¤å‘Šè­¦ï¼
          {{ end }}
        headers:
          Priority: 'high'
    
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=your-critical-dingtalk-token'
        send_resolved: true
        title: 'ğŸš¨ [ç´§æ€¥] è¾¹å¢™é²œé€ç³»ç»Ÿä¸¥é‡å‘Šè­¦'
        text: |
          ## ğŸš¨ ä¸¥é‡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          **å‘Šè­¦åç§°:** {{ .Annotations.summary }}
          
          **å‘Šè­¦æè¿°:** {{ .Annotations.description }}
          
          **å‘Šè­¦çº§åˆ«:** <font color="#FF0000">{{ .Labels.severity }}</font>
          
          **æœåŠ¡åç§°:** {{ .Labels.service }}
          
          **å®ä¾‹åœ°å€:** {{ .Labels.instance }}
          
          **å¼€å§‹æ—¶é—´:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          **è¯·ç«‹å³å¤„ç†æ­¤å‘Šè­¦ï¼**
          
          ---
          {{ end }}
  
  # è­¦å‘Šå‘Šè­¦æ¥æ”¶è€…
  - name: 'warning-alerts'
    email_configs:
      - to: 'dev@biangqiang.com'
        subject: '[è­¦å‘Š] è¾¹å¢™é²œé€ç³»ç»Ÿå‘Šè­¦'
        body: |
          âš ï¸ è­¦å‘Šå‘Šè­¦é€šçŸ¥ âš ï¸
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          æœåŠ¡åç§°: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
    
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=your-warning-dingtalk-token'
        send_resolved: true
        title: 'âš ï¸ [è­¦å‘Š] è¾¹å¢™é²œé€ç³»ç»Ÿå‘Šè­¦'
        text: |
          ## âš ï¸ è­¦å‘Šå‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          **å‘Šè­¦åç§°:** {{ .Annotations.summary }}
          
          **å‘Šè­¦æè¿°:** {{ .Annotations.description }}
          
          **å‘Šè­¦çº§åˆ«:** <font color="#FFA500">{{ .Labels.severity }}</font>
          
          **æœåŠ¡åç§°:** {{ .Labels.service }}
          
          **å®ä¾‹åœ°å€:** {{ .Labels.instance }}
          
          **å¼€å§‹æ—¶é—´:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          ---
          {{ end }}
  
  # æ•°æ®åº“å‘Šè­¦æ¥æ”¶è€…
  - name: 'database-alerts'
    email_configs:
      - to: 'dba@biangqiang.com,dev@biangqiang.com'
        subject: '[æ•°æ®åº“] è¾¹å¢™é²œé€ç³»ç»Ÿæ•°æ®åº“å‘Šè­¦'
        body: |
          ğŸ—„ï¸ æ•°æ®åº“å‘Šè­¦é€šçŸ¥ ğŸ—„ï¸
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          æ•°æ®åº“ç±»å‹: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          å»ºè®®æ£€æŸ¥æ•°æ®åº“è¿æ¥ã€æ€§èƒ½æŒ‡æ ‡å’Œæ—¥å¿—ã€‚
          {{ end }}
  
  # ç¼“å­˜å‘Šè­¦æ¥æ”¶è€…
  - name: 'cache-alerts'
    email_configs:
      - to: 'dev@biangqiang.com'
        subject: '[ç¼“å­˜] è¾¹å¢™é²œé€ç³»ç»Ÿç¼“å­˜å‘Šè­¦'
        body: |
          ğŸ’¾ ç¼“å­˜å‘Šè­¦é€šçŸ¥ ğŸ’¾
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          ç¼“å­˜ç±»å‹: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          å»ºè®®æ£€æŸ¥ç¼“å­˜è¿æ¥ã€å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½æŒ‡æ ‡ã€‚
          {{ end }}
  
  # åº”ç”¨æœåŠ¡å‘Šè­¦æ¥æ”¶è€…
  - name: 'application-alerts'
    email_configs:
      - to: 'dev@biangqiang.com'
        subject: '[åº”ç”¨] è¾¹å¢™é²œé€ç³»ç»Ÿåº”ç”¨å‘Šè­¦'
        body: |
          ğŸš€ åº”ç”¨å‘Šè­¦é€šçŸ¥ ğŸš€
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          åº”ç”¨æœåŠ¡: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          å»ºè®®æ£€æŸ¥åº”ç”¨æ—¥å¿—ã€æ€§èƒ½æŒ‡æ ‡å’Œå¥åº·çŠ¶æ€ã€‚
          {{ end }}
  
  # åŸºç¡€è®¾æ–½å‘Šè­¦æ¥æ”¶è€…
  - name: 'infrastructure-alerts'
    email_configs:
      - to: 'ops@biangqiang.com,admin@biangqiang.com'
        subject: '[åŸºç¡€è®¾æ–½] è¾¹å¢™é²œé€ç³»ç»ŸåŸºç¡€è®¾æ–½å‘Šè­¦'
        body: |
          ğŸ—ï¸ åŸºç¡€è®¾æ–½å‘Šè­¦é€šçŸ¥ ğŸ—ï¸
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          å»ºè®®æ£€æŸ¥æœåŠ¡å™¨èµ„æºã€ç½‘ç»œè¿æ¥å’Œç³»ç»ŸçŠ¶æ€ã€‚
          {{ end }}

---

# Prometheuså‘Šè­¦è§„åˆ™é…ç½®
# æ–‡ä»¶å: prometheus-rules.yml

groups:
  # ===========================================
  # ç³»ç»Ÿèµ„æºå‘Šè­¦è§„åˆ™
  # ===========================================
  - name: system-resources
    rules:
      # CPUä½¿ç”¨ç‡å‘Šè­¦
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          category: infrastructure
          service: system
        annotations:
          summary: "å®ä¾‹ {{ $labels.instance }} CPUä½¿ç”¨ç‡è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} CPUä½¿ç”¨ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡80%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          category: infrastructure
          service: system
        annotations:
          summary: "å®ä¾‹ {{ $labels.instance }} å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} å†…å­˜ä½¿ç”¨ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡85%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦
      - alert: HighDiskUsage
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs"} / node_filesystem_size_bytes{fstype!="tmpfs"})) * 100 > 90
        for: 5m
        labels:
          severity: critical
          category: infrastructure
          service: system
        annotations:
          summary: "å®ä¾‹ {{ $labels.instance }} ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} ç£ç›˜ {{ $labels.mountpoint }} ä½¿ç”¨ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡90%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # ç£ç›˜IOç­‰å¾…æ—¶é—´å‘Šè­¦
      - alert: HighDiskIOWait
        expr: irate(node_cpu_seconds_total{mode="iowait"}[5m]) * 100 > 20
        for: 10m
        labels:
          severity: warning
          category: infrastructure
          service: system
        annotations:
          summary: "å®ä¾‹ {{ $labels.instance }} ç£ç›˜IOç­‰å¾…æ—¶é—´è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} ç£ç›˜IOç­‰å¾…æ—¶é—´ä¸º {{ $value }}%ï¼Œè¶…è¿‡20%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
  
  # ===========================================
  # æœåŠ¡å¯ç”¨æ€§å‘Šè­¦è§„åˆ™
  # ===========================================
  - name: service-availability
    rules:
      # å®ä¾‹å®•æœºå‘Šè­¦
      - alert: InstanceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "å®ä¾‹ {{ $labels.instance }} å·²å®•æœº"
          description: "å®ä¾‹ {{ $labels.instance }} å·²ç»å®•æœºè¶…è¿‡1åˆ†é’Ÿ"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥å‘Šè­¦
      - alert: ServiceHealthCheckFailed
        expr: probe_success == 0
        for: 3m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "æœåŠ¡ {{ $labels.instance }} å¥åº·æ£€æŸ¥å¤±è´¥"
          description: "æœåŠ¡ {{ $labels.instance }} å¥åº·æ£€æŸ¥å·²å¤±è´¥è¶…è¿‡3åˆ†é’Ÿ"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # HTTPå“åº”æ—¶é—´è¿‡é•¿å‘Šè­¦
      - alert: HighHTTPResponseTime
        expr: probe_duration_seconds > 5
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "HTTPå“åº”æ—¶é—´è¿‡é•¿"
          description: "{{ $labels.instance }} HTTPå“åº”æ—¶é—´ä¸º {{ $value }}ç§’ï¼Œè¶…è¿‡5ç§’é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
  
  # ===========================================
  # åº”ç”¨æœåŠ¡å‘Šè­¦è§„åˆ™
  # ===========================================
  - name: application-services
    rules:
      # åº”ç”¨é”™è¯¯ç‡å‘Šè­¦
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 5
        for: 5m
        labels:
          severity: warning
          category: performance
          service: backend
        annotations:
          summary: "åº”ç”¨é”™è¯¯ç‡è¿‡é«˜"
          description: "åº”ç”¨ {{ $labels.instance }} é”™è¯¯ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡5%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # åº”ç”¨å“åº”æ—¶é—´å‘Šè­¦
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          category: performance
          service: backend
        annotations:
          summary: "åº”ç”¨å“åº”æ—¶é—´è¿‡é•¿"
          description: "åº”ç”¨ {{ $labels.instance }} 95%å“åº”æ—¶é—´ä¸º {{ $value }}ç§’ï¼Œè¶…è¿‡2ç§’é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # JVMå †å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
      - alert: HighJVMHeapUsage
        expr: jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} * 100 > 85
        for: 5m
        labels:
          severity: warning
          category: performance
          service: backend
        annotations:
          summary: "JVMå †å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "åº”ç”¨ {{ $labels.instance }} JVMå †å†…å­˜ä½¿ç”¨ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡85%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # GCæ—¶é—´è¿‡é•¿å‘Šè­¦
      - alert: HighGCTime
        expr: rate(jvm_gc_collection_seconds_sum[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          category: performance
          service: backend
        annotations:
          summary: "GCæ—¶é—´è¿‡é•¿"
          description: "åº”ç”¨ {{ $labels.instance }} GCæ—¶é—´ä¸º {{ $value }}ç§’/ç§’ï¼Œè¶…è¿‡0.1é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
  
  # ===========================================
  # æ•°æ®åº“å‘Šè­¦è§„åˆ™
  # ===========================================
  - name: database-mysql
    rules:
      # MySQLè¿æ¥æ•°å‘Šè­¦
      - alert: MySQLHighConnections
        expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: performance
          service: mysql
        annotations:
          summary: "MySQLè¿æ¥æ•°è¿‡é«˜"
          description: "MySQLå®ä¾‹ {{ $labels.instance }} è¿æ¥æ•°ä½¿ç”¨ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡80%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # MySQLæ…¢æŸ¥è¯¢å‘Šè­¦
      - alert: MySQLHighSlowQueries
        expr: rate(mysql_global_status_slow_queries[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: performance
          service: mysql
        annotations:
          summary: "MySQLæ…¢æŸ¥è¯¢è¿‡å¤š"
          description: "MySQLå®ä¾‹ {{ $labels.instance }} æ…¢æŸ¥è¯¢é€Ÿç‡ä¸º {{ $value }}æ¬¡/ç§’ï¼Œè¶…è¿‡10æ¬¡/ç§’é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # MySQLå¤åˆ¶å»¶è¿Ÿå‘Šè­¦
      - alert: MySQLReplicationLag
        expr: mysql_slave_lag_seconds > 30
        for: 5m
        labels:
          severity: warning
          category: performance
          service: mysql
        annotations:
          summary: "MySQLå¤åˆ¶å»¶è¿Ÿè¿‡é«˜"
          description: "MySQLä»åº“ {{ $labels.instance }} å¤åˆ¶å»¶è¿Ÿä¸º {{ $value }}ç§’ï¼Œè¶…è¿‡30ç§’é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # MySQLä¸å¯ç”¨å‘Šè­¦
      - alert: MySQLDown
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
          category: availability
          service: mysql
        annotations:
          summary: "MySQLæœåŠ¡ä¸å¯ç”¨"
          description: "MySQLå®ä¾‹ {{ $labels.instance }} å·²ä¸å¯ç”¨è¶…è¿‡1åˆ†é’Ÿ"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
  
  # ===========================================
  # Rediså‘Šè­¦è§„åˆ™
  # ===========================================
  - name: cache-redis
    rules:
      # Rediså†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: performance
          service: redis
        annotations:
          summary: "Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "Rediså®ä¾‹ {{ $labels.instance }} å†…å­˜ä½¿ç”¨ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡90%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # Redisè¿æ¥æ•°å‘Šè­¦
      - alert: RedisHighConnections
        expr: redis_connected_clients > 1000
        for: 5m
        labels:
          severity: warning
          category: performance
          service: redis
        annotations:
          summary: "Redisè¿æ¥æ•°è¿‡é«˜"
          description: "Rediså®ä¾‹ {{ $labels.instance }} è¿æ¥æ•°ä¸º {{ $value }}ï¼Œè¶…è¿‡1000é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # Redisé”®è¿‡æœŸé€Ÿç‡å‘Šè­¦
      - alert: RedisHighKeyEvictionRate
        expr: rate(redis_evicted_keys_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          category: performance
          service: redis
        annotations:
          summary: "Redisé”®è¿‡æœŸé€Ÿç‡è¿‡é«˜"
          description: "Rediså®ä¾‹ {{ $labels.instance }} é”®è¿‡æœŸé€Ÿç‡ä¸º {{ $value }}é”®/ç§’ï¼Œè¶…è¿‡100é”®/ç§’é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # Redisä¸å¯ç”¨å‘Šè­¦
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          category: availability
          service: redis
        annotations:
          summary: "RedisæœåŠ¡ä¸å¯ç”¨"
          description: "Rediså®ä¾‹ {{ $labels.instance }} å·²ä¸å¯ç”¨è¶…è¿‡1åˆ†é’Ÿ"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
  
  # ===========================================
  # ç½‘ç»œå‘Šè­¦è§„åˆ™
  # ===========================================
  - name: network
    rules:
      # ç½‘ç»œæ¥æ”¶é”™è¯¯å‘Šè­¦
      - alert: HighNetworkReceiveErrors
        expr: rate(node_network_receive_errs_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: infrastructure
          service: network
        annotations:
          summary: "ç½‘ç»œæ¥æ”¶é”™è¯¯ç‡è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} ç½‘ç»œæ¥å£ {{ $labels.device }} æ¥æ”¶é”™è¯¯ç‡ä¸º {{ $value }}é”™è¯¯/ç§’"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # ç½‘ç»œå‘é€é”™è¯¯å‘Šè­¦
      - alert: HighNetworkTransmitErrors
        expr: rate(node_network_transmit_errs_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: infrastructure
          service: network
        annotations:
          summary: "ç½‘ç»œå‘é€é”™è¯¯ç‡è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} ç½‘ç»œæ¥å£ {{ $labels.device }} å‘é€é”™è¯¯ç‡ä¸º {{ $value }}é”™è¯¯/ç§’"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
  
  # ===========================================
  # å®¹å™¨å‘Šè­¦è§„åˆ™
  # ===========================================
  - name: containers
    rules:
      # å®¹å™¨CPUä½¿ç”¨ç‡å‘Šè­¦
      - alert: ContainerHighCPUUsage
        expr: rate(container_cpu_usage_seconds_total{name!=""}[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          category: performance
          service: container
        annotations:
          summary: "å®¹å™¨CPUä½¿ç”¨ç‡è¿‡é«˜"
          description: "å®¹å™¨ {{ $labels.name }} CPUä½¿ç”¨ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡80%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # å®¹å™¨å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
      - alert: ContainerHighMemoryUsage
        expr: container_memory_usage_bytes{name!=""} / container_spec_memory_limit_bytes{name!=""} * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: performance
          service: container
        annotations:
          summary: "å®¹å™¨å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "å®¹å™¨ {{ $labels.name }} å†…å­˜ä½¿ç”¨ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡90%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # å®¹å™¨é‡å¯å‘Šè­¦
      - alert: ContainerRestarted
        expr: increase(kube_pod_container_status_restarts_total[1h]) > 5
        for: 0m
        labels:
          severity: warning
          category: availability
          service: container
        annotations:
          summary: "å®¹å™¨é¢‘ç¹é‡å¯"
          description: "å®¹å™¨ {{ $labels.container }} åœ¨è¿‡å»1å°æ—¶å†…é‡å¯äº† {{ $value }} æ¬¡"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
  
  # ===========================================
  # ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦è§„åˆ™
  # ===========================================
  - name: business-metrics
    rules:
      # è®¢å•å¤„ç†å¤±è´¥ç‡å‘Šè­¦
      - alert: HighOrderFailureRate
        expr: rate(order_processing_failed_total[5m]) / rate(order_processing_total[5m]) * 100 > 5
        for: 5m
        labels:
          severity: warning
          category: business
          service: backend
        annotations:
          summary: "è®¢å•å¤„ç†å¤±è´¥ç‡è¿‡é«˜"
          description: "è®¢å•å¤„ç†å¤±è´¥ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡5%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # æ”¯ä»˜å¤±è´¥ç‡å‘Šè­¦
      - alert: HighPaymentFailureRate
        expr: rate(payment_failed_total[5m]) / rate(payment_total[5m]) * 100 > 3
        for: 5m
        labels:
          severity: critical
          category: business
          service: backend
        annotations:
          summary: "æ”¯ä»˜å¤±è´¥ç‡è¿‡é«˜"
          description: "æ”¯ä»˜å¤±è´¥ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡3%é˜ˆå€¼"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"
      
      # ç”¨æˆ·ç™»å½•å¤±è´¥ç‡å‘Šè­¦
      - alert: HighLoginFailureRate
        expr: rate(user_login_failed_total[5m]) / rate(user_login_total[5m]) * 100 > 10
        for: 5m
        labels:
          severity: warning
          category: business
          service: backend
        annotations:
          summary: "ç”¨æˆ·ç™»å½•å¤±è´¥ç‡è¿‡é«˜"
          description: "ç”¨æˆ·ç™»å½•å¤±è´¥ç‡ä¸º {{ $value }}%ï¼Œè¶…è¿‡10%é˜ˆå€¼ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é—®é¢˜"
          timestamp: "{{ .ActiveAt.Format \"2006-01-02 15:04:05\" }}"